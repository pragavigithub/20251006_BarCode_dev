# Warehouse Management System (WMS)

## Overview
A Flask-based Warehouse Management System (WMS) designed to streamline inventory operations. It features seamless integration with SAP for core functionalities like barcode scanning, goods receipt, pick list generation, and inventory transfers. The system aims to enhance efficiency, accuracy, and control over warehouse logistics. The project envisions a future where warehouse operations are fully digitized, minimizing manual errors and maximizing throughput, potentially serving as a model for small to medium-sized enterprises.

## Recent Changes
*   **2025-10-25**: **DIRECT INVENTORY TRANSFER MODULE** - Created comprehensive new "Direct Inventory Transfer" module for barcode-based inventory transfers with automatic serial/batch detection via SAP B1 integration. Features include: camera-based barcode scanning for item codes, automatic SAP B1 item validation with serial/batch management detection, intelligent serial number tracking (count must match quantity), batch number validation, warehouse and bin selection with SAP integration, QC approval workflow, direct posting to SAP B1 as StockTransfers documents with full audit trail. Module includes PostgreSQL database models (DirectInventoryTransfer, DirectInventoryTransferItem), comprehensive routes with validation endpoints, three responsive templates (index, create, detail), new SAP integration methods (validate_item_for_direct_transfer, post_direct_inventory_transfer_to_sap, get_bins), and user permission system integration. Architect-reviewed and approved.
*   **2025-10-24**: **INVENTORY TRANSFER WAREHOUSE DISPLAY FIX** - Fixed incorrect warehouse display in Inventory Transfer Available Items table where both "From Warehouse" and "To Warehouse" columns were showing the same value. Root cause: SAP StockTransferRequest line items typically only contain WarehouseCode (destination), not FromWarehouseCode. Updated routes.py to provide intelligent fallbacks: FromWarehouseCode uses line-level value or header-level FromWarehouse; ToWarehouseCode uses line-level WarehouseCode or header-level ToWarehouse. This ensures distinct From/To warehouse values are displayed correctly. Architect-reviewed and approved.
*   **2025-10-24**: **BARCODE SCANNING FOR SALES DELIVERY** - Implemented full barcode scanning functionality for the SalesOrder Against Delivery module. Features include: camera-based barcode scanning using QuaggaJS library, support for two barcode formats (plain item code and DELIVERY:{ItemCode}-{Batch/Serial}), automatic SO line matching and validation, smart quantity handling (defaults to 1 or remaining qty), comprehensive error handling with in-modal feedback, manual entry fallback when camera unavailable, and 1.5-second success confirmation before page reload. Camera stops immediately after successful scan. Requires HTTPS or localhost for camera access (already provided by Replit). Architect-reviewed and approved.
*   **2025-10-24**: **SALES DELIVERY MODAL FREEZE FIX** - Fixed persistent screen freeze issue when clicking "Add Item Manually" button. Root cause was threefold: (1) Z-index conflict - Add Item Modal lacked z-index styles causing backdrop to block interaction, (2) Conflicting modal initialization - dual Bootstrap modal management causing state conflicts, (3) DOM timing issues. Solution: Extended z-index styles to both modals (#addItemModal, #qrModal: 9999, .modal-backdrop: 9998), removed conflicting explicit modal initialization to let Bootstrap's data-api handle naturally, wrapped event listeners in DOMContentLoaded with comprehensive null-checks and error handling. Modal now opens and remains fully interactive without any freeze. Architect-reviewed and approved.
*   **2025-10-24**: **SALES DELIVERY PRINT & MODAL FIXES** - Resolved three additional UX issues in SalesOrder Against Delivery module: (1) Fixed screen freeze when clicking "Add Item Manually" button by removing unused JavaScript variable and adding explicit Bootstrap modal initialization with safety checks, (2) Enhanced QR label print styling with bold 14pt font and proper spacing to ensure all four fields (Item Code, Batch/Serial, Warehouse, QR Data) are clearly visible, (3) Added comprehensive print-specific CSS to show ONLY QR modal content when printing, hiding all background pages and navigation. Print output now displays clean QR labels with complete details. All fixes architect-reviewed and approved.
*   **2025-10-24**: **SALES DELIVERY UI/UX FIXES** - Resolved critical user experience issues in SalesOrder Against Delivery module: (1) QR modal z-index corrected (modal: 9999, backdrop: 9998) to appear above all content, (2) Open quantity validation with cumulative tracking to prevent over-delivery, (3) CardCode fallback logic - fetches from SAP if missing from local delivery record, (4) Header details fallback pattern displays live SAP data when delivery record incomplete, (5) BaseLine validation fix - changed to `isNaN()` to allow SAP line 0 (first line), (6) Fractional quantity support restored (`step="0.01"` `min="0.01"`), (7) Quantity defaults to remaining open quantity instead of capped at 1. All fixes architect-reviewed and approved.
*   **2025-10-24**: **SALES DELIVERY SQL QUERY INTEGRATION** - Updated SalesOrder Against Delivery module to use custom SQL queries as primary method with robust fallback chain. `get_so_series()` now tries: (1) SQL Query `Get_SO_Series` for full series list with proper names, (2) v2 Series API, (3) v1 Orders query as last resort. `get_so_doc_entry()` now tries: (1) SQL Query `Get_SO_Details` with ParamList parameters, (2) OData filter on Orders table. This leverages existing SAP B1 SQL query configuration while maintaining backward compatibility with systems that don't have SQL queries configured. Added comprehensive logging with emoji indicators for easy troubleshooting of which method succeeded.
*   **2025-10-23**: **SALES ORDER AGAINST DELIVERY MODULE** - Created new "SalesOrder Against Delivery" module for creating Delivery Notes against Sales Orders. Features include: SO series selection, document loading, item entry with batch/serial validation, individual QR code generation for warehouse routing, and direct SAP B1 posting. Local PostgreSQL tracking with full audit trail. MySQL migration file created at `migrations/mysql/changes/2025-10-23_sales_delivery_module.sql`.
*   **2025-10-23**: **INVENTORY COUNTING SIMPLIFIED** - Removed "Local Counting" method from navigation. "Counting" menu item now directly links to SAP B1 Inventory Counting, eliminating the dropdown menu and simplifying user experience.
*   **2025-10-23**: **SAP COUNTING LOCAL STORAGE** - Implemented local PostgreSQL database storage for SAP B1 Inventory Counting documents. All loaded counting documents and their lines are now automatically saved locally with full audit trail (user tracking, timestamps, variance calculation). MySQL migration file created at `migrations/mysql/changes/2025-10-23_sap_inventory_counting_local_storage.sql`.
*   **2025-10-23**: **DASHBOARD ERROR FIXED** - Resolved AttributeError: 'InventoryCount' object has no attribute 'count_name'. Updated dashboard route to use correct field name `count_number` instead of `count_name`.
*   **2025-10-17**: Disabled automatic SAP item code validation in GRPO "Add Item" functionality. Users can now enter item codes manually without triggering SAP validation alerts. All batch/serial fields are now available for manual entry by default, improving workflow flexibility when SAP validation is unavailable or unnecessary.
*   **2025-10-17**: Fixed Jinja2 template structure error in GRPO detail page (`grpo_detail.html`). Added missing `{% endblock %}` tag to properly close the scripts block after JavaScript code. The QR modal is now correctly placed in the content block. Template now renders without "Unexpected end of template" errors.
*   **2025-10-17**: Fixed critical JavaScript rendering issue in GRPO detail page (`grpo_detail.html`). Resolved duplicate `{% endblock %}` template tag and escaped `</script>` tag within JavaScript template literal to prevent premature script termination. JavaScript code is now properly executed instead of being displayed as text on the page.
*   **2025-10-17**: Enhanced GRPO "Add Item to GRN" UI logic to properly hide batch number and expiration date fields when item is serial-managed. Updated JavaScript validation to target the entire batch/expiration row for consistent visibility toggling between batch and serial fields.
*   **2025-10-17**: Added barcode generation functionality for batch numbers in GRPO module. Batch-managed items now have a "Generate Barcode" button that creates QR codes with the format "BATCH:{itemCode}-{batchNumber}" and includes print functionality.

## User Preferences
*   Keep MySQL migration files updated when database schema changes occur

## System Architecture
The system is built on a Flask web application backend, utilizing Jinja2 for server-side rendering. A core architectural decision is the deep integration with the SAP B1 Service Layer API for all critical warehouse operations, ensuring data consistency and real-time updates. SQLite serves as a fallback database, while PostgreSQL is the primary target for cloud deployments. User authentication uses Flask-Login with robust role-based access control. The application is designed for production deployment using Gunicorn with autoscale capabilities.

**Key Features:**
*   **User Management:** Comprehensive authentication, role-based access, and self-service profile management. Deactivation replaces deletion for audit trails.
*   **GRPO Management:** Includes standard Goods Receipt PO processing with intelligent batch/serial field management and a new module for batch creation of multiple GRNs from multiple Purchase Orders via a 5-step workflow with SAP B1 integration.
    *   **Dynamic Batch/Serial Detection (NEW):** Automatically validates item codes against SAP B1 to determine if items are batch-managed or serial-managed, showing only relevant input fields
    *   **Serial Number Entry:** For serial-managed items, dynamically generates individual serial number inputs based on received quantity with automatic barcode generation
    *   **Batch Number Entry:** For batch-managed items, enables batch number selection with expiration date tracking
*   **Inventory Transfer:** Enhanced module for creating inventory transfer requests with document series selection and validation against SAP B1.
*   **Direct Inventory Transfer:** Streamlined barcode-based inventory transfer module with automatic serial/batch detection. Features real-time SAP B1 item validation, intelligent serial number tracking with quantity matching, batch number validation, warehouse and bin selection via SAP integration, QC approval workflow, and direct posting to SAP B1 as StockTransfers documents with complete audit trail tracking.
*   **Sales Order Against Delivery:** Comprehensive module for creating Delivery Notes against Sales Orders with full SAP B1 integration. Features include SO series selection, document loading with open line filtering, item-by-item picking with batch/serial validation, individual QR code label generation for warehouse routing, and direct SAP B1 posting with local audit trail tracking.
*   **Pick List Management:** Generation and processing of pick lists.
*   **Barcode Scanning:** Integrated camera-based scanning for various modules (GRPO, Bin Scanning, Pick List, Inventory Transfer, Barcode Reprint), requiring HTTPS for local development.
*   **Inventory Counting:** SAP B1 integrated inventory counting with local database storage for tracking and audit trails. All counting documents and updates are automatically saved to PostgreSQL with user tracking and timestamps.
*   **Branch Management:** Functionality for managing different warehouse branches.
*   **Quality Control Dashboard:** Provides oversight for quality processes.
*   **UI/UX:** Focuses on intuitive workflows for managing inventory, including serial number transfers and real-time validation against SAP B1.
*   **Database Migrations:** A comprehensive MySQL migration tracking system is in place for schema changes, complementing the primary PostgreSQL strategy.

**Technical Implementations:**
*   **SAP B1 Integration:** Utilizes a dedicated `SAPMultiGRNService` class for secure and robust communication with the SAP B1 Service Layer, including SSL/TLS verification. OData filtering is optimized for `CardCode` for reliability.
*   **Modular Design:** New features like Multi-GRN Creation are implemented as modular blueprints with their own templates and services.
*   **Frontend:** Jinja2 templating with JavaScript libraries like Select2 for enhanced UI components.
*   **Error Handling:** Comprehensive validation and error logging for API communications and user inputs.

## External Dependencies
*   **SAP B1 Service Layer API**: For all core inventory and document management functionalities (GRPO, pick lists, inventory transfers, serial numbers, business partners, inventory counts).
*   **PostgreSQL**: Primary relational database for production environments.
*   **SQLite**: Local relational database for development and initial setup.
*   **Gunicorn**: WSGI HTTP server for deploying the Flask application in production.
*   **Flask-Login**: Library for managing user sessions and authentication.