{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('multi_grn.index') }}">Multiple GRN</a></li>
            <li class="breadcrumb-item active">Step 4: Review & Confirm</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-check-circle"></i> Step 4: Review & Confirm</h4>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>Customer:</strong> {{ batch.customer_name }} ({{ batch.customer_code }})<br>
                <strong>Total POs:</strong> {{ batch.po_links | length }}<br>
                <strong>Total Items:</strong> {{ batch.po_links | sum(attribute='line_selections.count') }}
            </div>

            {% for po_link in batch.po_links %}
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5>PO #{{ po_link.po_doc_num }}</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Warehouse</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for line in po_link.line_selections %}
                            <tr>
                                <td>{{ line.item_code }}</td>
                                <td>{{ line.item_description }}</td>
                                <td>{{ line.selected_quantity }}</td>
                                <td>{{ line.warehouse_code }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}

            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('multi_grn.create_step3_select_lines', batch_id=batch.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
                <button type="button" class="btn btn-success" id="confirmBtn">
                    <i class="fas fa-paper-plane"></i> Confirm & Post GRNs
                </button>
            </div>

            <div id="resultDiv" class="mt-4"></div>
        </div>
    </div>
</div>

<script>
document.getElementById('confirmBtn').addEventListener('click', function() {
    if (!confirm('Are you sure you want to post these GRNs to SAP B1?')) return;
    
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Posting...';
    
    fetch('{{ url_for("multi_grn.create_step5_post", batch_id=batch.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        const resultDiv = document.getElementById('resultDiv');
        
        if (data.success) {
            let html = '<div class="alert alert-success"><h5>✅ GRNs Posted Successfully!</h5>';
            html += `<p>Total Success: ${data.total_success} | Total Failed: ${data.total_failed}</p>`;
            html += '<ul>';
            data.results.forEach(r => {
                if (r.success) {
                    html += `<li>PO ${r.po_num}: GRN #${r.grn_num} created</li>`;
                } else {
                    html += `<li class="text-danger">PO ${r.po_num}: Failed - ${r.error}</li>`;
                }
            });
            html += '</ul>';
            html += `<a href="{{ url_for('multi_grn.view_batch', batch_id=batch.id) }}" class="btn btn-primary mt-2">View Batch Details</a></div>`;
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">❌ Error: ${data.error}</div>`;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Confirm & Post GRNs';
        }
    })
    .catch(err => {
        document.getElementById('resultDiv').innerHTML = `<div class="alert alert-danger">❌ Error: ${err.message}</div>`;
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Confirm & Post GRNs';
    });
});
</script>
{% endblock %}
