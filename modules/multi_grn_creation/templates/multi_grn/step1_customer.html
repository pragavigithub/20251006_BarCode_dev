{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('multi_grn.index') }}">Multiple GRN</a></li>
            <li class="breadcrumb-item active">Step 1: Select Customer</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-user-tie"></i> Step 1: Select Customer</h4>
        </div>
        <div class="card-body">
            <form method="POST" id="customerForm">
                <div class="mb-3">
                    <label for="customerSearch" class="form-label">Search Customer *</label>
                    <input type="text" class="form-control" id="customerSearch" placeholder="Type customer name or code..." autocomplete="off">
                    <div id="customerResults" class="list-group mt-2" style="max-height: 300px; overflow-y: auto;"></div>
                </div>

                <input type="hidden" name="customer_code" id="customer_code" required>
                <input type="hidden" name="customer_name" id="customer_name" required>

                <div id="selectedCustomer" class="alert alert-info d-none">
                    <strong>Selected:</strong> <span id="selectedCustomerName"></span>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('multi_grn.index') }}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary" id="nextBtn" disabled>
                        Next: Select POs <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let searchTimeout;
const customerSearch = document.getElementById('customerSearch');
const customerResults = document.getElementById('customerResults');
const selectedCustomer = document.getElementById('selectedCustomer');
const nextBtn = document.getElementById('nextBtn');

customerSearch.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length < 2) {
        customerResults.innerHTML = '';
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetch(`/multi-grn/api/search-customers?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                customerResults.innerHTML = '';
                
                if (data.customers && data.customers.length > 0) {
                    data.customers.forEach(customer => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `<strong>${customer.CardName}</strong><br><small>${customer.CardCode}</small>`;
                        item.onclick = (e) => {
                            e.preventDefault();
                            selectCustomer(customer.CardCode, customer.CardName);
                        };
                        customerResults.appendChild(item);
                    });
                } else {
                    customerResults.innerHTML = '<div class="list-group-item">No customers found</div>';
                }
            })
            .catch(err => {
                console.error('Error searching customers:', err);
                customerResults.innerHTML = '<div class="list-group-item text-danger">Error loading customers</div>';
            });
    }, 300);
});

function selectCustomer(code, name) {
    document.getElementById('customer_code').value = code;
    document.getElementById('customer_name').value = name;
    document.getElementById('selectedCustomerName').textContent = `${name} (${code})`;
    selectedCustomer.classList.remove('d-none');
    customerResults.innerHTML = '';
    customerSearch.value = name;
    nextBtn.disabled = false;
}
</script>
{% endblock %}
